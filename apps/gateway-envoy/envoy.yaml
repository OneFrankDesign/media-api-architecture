static_resources:
  listeners:
    - name: ingress_listener
      address:
        socket_address:
          address: 0.0.0.0
          port_value: 8080
      filter_chains:
        - filters:
            - name: envoy.filters.network.http_connection_manager
              typed_config:
                "@type": type.googleapis.com/envoy.extensions.filters.network.http_connection_manager.v3.HttpConnectionManager
                stat_prefix: ingress_http
                codec_type: AUTO
                route_config:
                  name: local_route
                  virtual_hosts:
                    - name: media_api
                      domains: ["*"]
                      routes:
                        - match:
                            prefix: "/auth"
                          route:
                            cluster: auth_api
                        - match:
                            prefix: "/"
                          route:
                            cluster: main_api
                http_filters:
                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      source_code:
                        inline_string: |
                          function envoy_on_response(response_handle)
                            response_handle:headers():add("Content-Security-Policy", "default-src 'self'; frame-ancestors 'none'; base-uri 'self';")
                            response_handle:headers():add("X-Content-Type-Options", "nosniff")
                            response_handle:headers():add("X-Frame-Options", "DENY")
                            response_handle:headers():add("Referrer-Policy", "strict-origin-when-cross-origin")
                          end

                  - name: envoy.filters.http.lua
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.lua.v3.Lua
                      source_code:
                        inline_string: |
                          local allowed = {
                            ["http://localhost:3000"] = true,
                            ["https://app.localhost"] = true
                          }

                          function envoy_on_request(request_handle)
                            local method = request_handle:headers():get(":method")
                            if method == "OPTIONS" then
                              return
                            end

                            local sec_fetch_site = request_handle:headers():get("sec-fetch-site")
                            local sec_fetch_mode = request_handle:headers():get("sec-fetch-mode")
                            if sec_fetch_site == "cross-site" and sec_fetch_mode == "navigate" then
                              request_handle:respond({[":status"] = "403"}, "cross-site navigation blocked")
                              return
                            end

                            if method ~= "GET" and method ~= "HEAD" then
                              local origin = request_handle:headers():get("origin")
                              if not origin or not allowed[origin] then
                                request_handle:respond({[":status"] = "403"}, "invalid origin")
                                return
                              end

                              local csrf_header = request_handle:headers():get("x-csrf-token")
                              local cookie_header = request_handle:headers():get("cookie")
                              local csrf_cookie = nil
                              if cookie_header then
                                for cookie in string.gmatch(cookie_header, "([^;]+)") do
                                  local name, value = string.match(cookie, "^%s*(.-)=(.+)$")
                                  if name and string.match(name, "^%s*csrf%-token%s*$") then
                                    csrf_cookie = value
                                    break
                                  end
                                end
                              end

                              if not csrf_header or not csrf_cookie or csrf_header ~= csrf_cookie then
                                request_handle:respond({[":status"] = "403"}, "csrf token mismatch")
                                return
                              end
                            end
                          end

                  - name: envoy.filters.http.jwt_authn
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.jwt_authn.v3.JwtAuthentication
                      providers:
                        oidc:
                          issuer: "https://your-issuer.example.com/oauth2/default"
                          audiences: ["media-api"]
                          remote_jwks:
                            http_uri:
                              uri: "https://your-issuer.example.com/oauth2/default/v1/keys"
                              cluster: oidc_jwks
                              timeout: 5s
                      rules:
                        - match:
                            prefix: "/health"
                        - match:
                            prefix: "/auth"
                        - match:
                            prefix: "/"
                          requires:
                            provider_name: oidc

                  - name: envoy.filters.http.ext_authz
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.ext_authz.v3.ExtAuthz
                      transport_api_version: V3
                      http_service:
                        server_uri:
                          uri: http://opa:8181
                          cluster: opa
                          timeout: 0.25s
                        path_prefix: /v1/data/rbac/allow
                        authorization_request:
                          allowed_headers:
                            patterns:
                              - exact: authorization
                              - exact: x-jwt-payload
                              - exact: :path
                              - exact: :method

                  - name: envoy.filters.http.grpc_web
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.grpc_web.v3.GrpcWeb

                  - name: envoy.filters.http.router
                    typed_config:
                      "@type": type.googleapis.com/envoy.extensions.filters.http.router.v3.Router

  clusters:
    - name: main_api
      connect_timeout: 1s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: main_api
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: main-api
                      port_value: 50051
      typed_extension_protocol_options:
        envoy.extensions.upstreams.http.v3.HttpProtocolOptions:
          "@type": type.googleapis.com/envoy.extensions.upstreams.http.v3.HttpProtocolOptions
          explicit_http_config:
            http2_protocol_options: {}

    - name: auth_api
      connect_timeout: 1s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: auth_api
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: auth-api
                      port_value: 8081

    - name: opa
      connect_timeout: 1s
      type: STRICT_DNS
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: opa
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: opa
                      port_value: 8181

    - name: oidc_jwks
      connect_timeout: 2s
      type: LOGICAL_DNS
      dns_lookup_family: V4_ONLY
      lb_policy: ROUND_ROBIN
      load_assignment:
        cluster_name: oidc_jwks
        endpoints:
          - lb_endpoints:
              - endpoint:
                  address:
                    socket_address:
                      address: your-issuer.example.com
                      port_value: 443
      transport_socket:
        name: envoy.transport_sockets.tls
        typed_config:
          "@type": type.googleapis.com/envoy.extensions.transport_sockets.tls.v3.UpstreamTlsContext

admin:
  access_log_path: /tmp/admin_access.log
  address:
    socket_address:
      address: 0.0.0.0
      port_value: 9901
